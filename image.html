<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Конвертер изображений онлайн</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f5f5f0;
      --surface: #ebebeb;
      --border: #222;
      --text: #111;
      --text-muted: #666;
      --accent: #111;
      --accent-inv: #f5f5f0;
      --shadow: rgba(0,0,0,0.15);
      --drop-bg: #e2e2dd;
      --success: #1a1a1a;
      --tick: #111;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0e0e0e;
        --surface: #1a1a1a;
        --border: #d8d8d8;
        --text: #f0f0f0;
        --text-muted: #888;
        --accent: #f0f0f0;
        --accent-inv: #0e0e0e;
        --shadow: rgba(255,255,255,0.06);
        --drop-bg: #161616;
        --success: #e0e0e0;
        --tick: #f0f0f0;
      }
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 3rem 1.5rem 5rem;
      transition: background 0.3s, color 0.3s;
    }

    /* Noise texture overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 999;
      opacity: 0.025;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      background-size: 200px 200px;
    }

    header {
      width: 100%;
      max-width: 680px;
      margin-bottom: 3.5rem;
    }

    .label-top {
      font-size: 0.65rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(3rem, 10vw, 5.5rem);
      font-weight: 900;
      line-height: 0.9;
      letter-spacing: -0.03em;
      color: var(--text);
    }

    h1 span {
      display: block;
      -webkit-text-stroke: 1.5px var(--text);
      color: transparent;
    }

    .subtitle {
      margin-top: 1rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      letter-spacing: 0.05em;
    }

    /* Drop zone */
    .drop-zone {
      width: 100%;
      max-width: 680px;
      border: 1.5px solid var(--border);
      background: var(--drop-bg);
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      position: relative;
      transition: background 0.2s, transform 0.15s;
      outline: none;
    }

    .drop-zone::before {
      content: '';
      position: absolute;
      inset: 5px;
      border: 1px dashed var(--border);
      pointer-events: none;
      opacity: 0.35;
    }

    .drop-zone:hover, .drop-zone.drag-over {
      background: var(--surface);
      transform: translateY(-2px);
    }

    .drop-zone:focus-visible {
      box-shadow: 0 0 0 3px var(--text);
    }

    .drop-icon {
      display: block;
      margin: 0 auto 1.25rem;
      width: 48px;
      height: 48px;
      opacity: 0.7;
    }

    .drop-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.4rem;
    }

    .drop-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    #file-input { display: none; }

    /* Results */
    #results {
      width: 100%;
      max-width: 680px;
      margin-top: 2rem;
      display: none;
    }

    #results.visible { display: block; }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    .results-label {
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    #count {
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .file-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      border: 1px solid var(--border);
      padding: 0.9rem 1rem;
      background: var(--surface);
      animation: slide-in 0.25s ease both;
    }

    @keyframes slide-in {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .file-thumb {
      width: 44px;
      height: 44px;
      object-fit: cover;
      border: 1px solid var(--border);
      flex-shrink: 0;
      filter: grayscale(1);
    }

    .file-info {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-size: 0.78rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 0.2rem;
    }

    .file-size {
      font-size: 0.62rem;
      color: var(--text-muted);
      letter-spacing: 0.06em;
    }

    .status {
      font-size: 0.62rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .status.processing { color: var(--text-muted); }
    .status.done { color: var(--tick); }

    .download-btn {
      flex-shrink: 0;
      background: var(--accent);
      color: var(--accent-inv);
      border: none;
      padding: 0.45rem 0.9rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.65rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: opacity 0.15s, transform 0.1s;
    }

    .download-btn:hover { opacity: 0.75; transform: translateY(-1px); }

    /* Download all */
    .actions {
      margin-top: 1.5rem;
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .btn-secondary {
      background: transparent;
      color: var(--text);
      border: 1.5px solid var(--border);
      padding: 0.6rem 1.2rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }

    .btn-secondary:hover {
      background: var(--accent);
      color: var(--accent-inv);
    }

    .btn-primary {
      background: var(--accent);
      color: var(--accent-inv);
      border: 1.5px solid var(--accent);
      padding: 0.6rem 1.2rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .btn-primary:hover { opacity: 0.75; }

    footer {
      margin-top: 5rem;
      font-size: 0.62rem;
      color: var(--text-muted);
      letter-spacing: 0.12em;
      text-align: center;
    }

    canvas { display: none; }

    /* Progress bar */
    .progress-bar-wrap {
      width: 100%;
      height: 2px;
      background: var(--border);
      margin-top: 0.4rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .progress-bar-wrap.active { opacity: 1; }
    .progress-bar {
      height: 100%;
      background: var(--text);
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>

<header>
  <p class="label-top">// image converter</p>
  <h1>WEBP<span>→ PNG</span></h1>
  <p class="subtitle">конвертация без загрузки на сервер — всё происходит в браузере</p>
</header>

<div class="drop-zone" id="drop-zone" tabindex="0" role="button" aria-label="Перетащите WebP файлы или нажмите для выбора">
  <svg class="drop-icon" viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.5" xmlns="http://www.w3.org/2000/svg">
    <rect x="6" y="10" width="36" height="28" rx="1"/>
    <path d="M16 28l6-8 5 6 3-4 6 6"/>
    <circle cx="17" cy="20" r="2"/>
    <path d="M24 4v6M21 7l3-3 3 3"/>
  </svg>
  <p class="drop-title">Перетащите файлы сюда</p>
  <p class="drop-hint">или нажмите для выбора · .webp</p>
  <div class="progress-bar-wrap" id="progress-wrap">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
</div>
<input type="file" id="file-input" accept=".webp,image/webp" multiple />

<section id="results">
  <div class="results-header">
    <span class="results-label">Результат</span>
    <span id="count">0 файлов</span>
  </div>
  <ul class="file-list" id="file-list"></ul>
  <div class="actions">
    <button class="btn-secondary" id="clear-btn">Очистить</button>
    <button class="btn-primary" id="download-all-btn">Скачать все</button>
  </div>
</section>

<canvas id="canvas"></canvas>
<footer>все файлы обрабатываются локально · данные не покидают ваш браузер</footer>

<script>
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');
  const results = document.getElementById('results');
  const fileList = document.getElementById('file-list');
  const countEl = document.getElementById('count');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const progressWrap = document.getElementById('progress-wrap');
  const progressBar = document.getElementById('progress-bar');
  const clearBtn = document.getElementById('clear-btn');
  const downloadAllBtn = document.getElementById('download-all-btn');

  let convertedFiles = []; // {name, blob, url}

  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') fileInput.click(); });

  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const files = [...e.dataTransfer.files].filter(f => f.type === 'image/webp' || f.name.endsWith('.webp'));
    if (files.length) processFiles(files);
  });

  fileInput.addEventListener('change', () => {
    const files = [...fileInput.files];
    if (files.length) processFiles(files);
    fileInput.value = '';
  });

  async function processFiles(files) {
    progressWrap.classList.add('active');
    progressBar.style.width = '0%';

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      progressBar.style.width = `${Math.round(((i) / files.length) * 100)}%`;
      await convertFile(file);
      progressBar.style.width = `${Math.round(((i + 1) / files.length) * 100)}%`;
    }

    setTimeout(() => { progressWrap.classList.remove('active'); progressBar.style.width = '0%'; }, 600);

    results.classList.add('visible');
    updateCount();
  }

  function convertFile(file) {
    return new Promise(resolve => {
      const pngName = file.name.replace(/\.webp$/i, '.png');

      // Add placeholder item
      const li = document.createElement('li');
      li.className = 'file-item';
      li.innerHTML = `
        <div class="file-thumb-placeholder" style="width:44px;height:44px;border:1px solid var(--border);flex-shrink:0;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:0.5rem;color:var(--text-muted)">...</div>
        <div class="file-info">
          <div class="file-name">${escHtml(pngName)}</div>
          <div class="file-size">${formatSize(file.size)}</div>
        </div>
        <span class="status processing">конвертация</span>
      `;
      fileList.prepend(li);

      const img = new Image();
      const objUrl = URL.createObjectURL(file);
      img.onload = () => {
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(objUrl);

        canvas.toBlob(blob => {
          const pngUrl = URL.createObjectURL(blob);
          convertedFiles.push({ name: pngName, blob, url: pngUrl });

          // Build thumbnail
          const thumbImg = document.createElement('img');
          thumbImg.className = 'file-thumb';
          thumbImg.src = pngUrl;
          thumbImg.alt = pngName;

          const placeholder = li.querySelector('.file-thumb-placeholder');
          li.replaceChild(thumbImg, placeholder);

          const statusEl = li.querySelector('.status');
          statusEl.textContent = '✓ готово';
          statusEl.className = 'status done';

          const dlBtn = document.createElement('a');
          dlBtn.href = pngUrl;
          dlBtn.download = pngName;
          dlBtn.className = 'download-btn';
          dlBtn.textContent = 'Скачать';
          li.appendChild(dlBtn);

          resolve();
        }, 'image/png');
      };
      img.onerror = () => {
        const statusEl = li.querySelector('.status');
        statusEl.textContent = '✗ ошибка';
        statusEl.style.color = 'var(--text)';
        URL.revokeObjectURL(objUrl);
        resolve();
      };
      img.src = objUrl;
    });
  }

  function updateCount() {
    const n = fileList.querySelectorAll('.file-item').length;
    countEl.textContent = `${n} ${plural(n, 'файл', 'файла', 'файлов')}`;
  }

  function plural(n, one, few, many) {
    const mod10 = n % 10, mod100 = n % 100;
    if (mod10 === 1 && mod100 !== 11) return one;
    if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) return few;
    return many;
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1024 / 1024).toFixed(2) + ' MB';
  }

  function escHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  clearBtn.addEventListener('click', () => {
    fileList.innerHTML = '';
    convertedFiles.forEach(f => URL.revokeObjectURL(f.url));
    convertedFiles = [];
    results.classList.remove('visible');
  });

  downloadAllBtn.addEventListener('click', async () => {
    if (!convertedFiles.length) return;
    if (convertedFiles.length === 1) {
      const a = document.createElement('a');
      a.href = convertedFiles[0].url;
      a.download = convertedFiles[0].name;
      a.click();
      return;
    }
    // Multiple files — use JSZip if available, otherwise download one by one
    for (const f of convertedFiles) {
      const a = document.createElement('a');
      a.href = f.url;
      a.download = f.name;
      a.click();
      await new Promise(r => setTimeout(r, 200));
    }
  });
</script>
</body>
</html>
